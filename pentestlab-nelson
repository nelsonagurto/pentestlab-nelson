#!/bin/bash

# variable local para listar hosts
HOSTS=/etc/hosts

# 		Menu Ayuda Pentestlab-Nelson	   #
############################################
despliega_help() {
    echo "Script Local de Manego PentestLab  (basedo en Docker)"
    echo
    echo "Usage: $0 {list|status|info|start|stop} [projectname]" >&2
    echo
	echo " Este script usa docker y alias de hosts para reconocer web en entorno local (localhost)"
    echo 
    echo " Ejemplos."
    echo " $0 list"
    echo " 	Lista todos los proyectos diponibles"
    echo " $0 status"
    echo "	Muestra el Status de los proyectos"
    echo " $0 start"
    echo " 	Arranca el proyecto en localhost" 
    echo " $0 info"
    echo " 	Muestra informaciòn del Proyecto"
    echo
    echo "  Dockerfiles desde:"
    echo "  Mutillidae II           - Nikolay Golub (citizenstig/nowasp)"
    echo "  bWapp                   - Rory McCune (raesene/bwapp)"
    echo "  Webgoat(s)              - OWASP Project"
    echo "  NodeGoat		   		- Ben McMahon (bjm243/nodegoat)"
    echo "  Vulnerable Wordpress    - WPScan Team (l505/vulnerablewordpress)"
    exit 1
}

# Reviso Docker esta instalado y corriendo #
############################################
if ! [ -x "$(command -v docker)" ]; then
  echo 
  echo "Docker no fue encontrado. Favor de instalar Docker antes de correr el script."
  echo "Puede instalar: install_docker_kali_x64.sh"
  echo "Desde el Repo https://github.com/nelsonagurto/pentestlab-nelson.git"
  exit
fi

if sudo service docker status | grep inactive > /dev/null
then 
	echo "Docker no està corriendo"
	echo -n "Desea correro Docker ahora(s/n)?"
	read answer
	if echo "$answer" | grep -iq "^s"; then
		sudo service docker start
	else
		echo "Docker no arranca. El Script no se puede establecer para correr las aplicaciones."
	fi
fi

# Listado de todas las aplicaciones Pentest #
#############################################
list() {
    echo "Aplicacciones PentestLab-Nelson" >&2
	echo "------------------------------------------------------------------"
    echo "  bwapp 		    	- bWAPP PHP/MySQL based from itsecgames.com"
    echo "  webgoat7			- WebGoat 7.1 OWASP Flagship Project"
    echo "  nodegoat			- NodeGoat OWASP Project"
    echo "  mutillidae			- OWASP Mutillidae II"
    echo "  vulnerablewordpress	- WPScan Vulnerable Wordpress"
    echo "------------------------------------------------------------------"
    exit 1
}

# Informacion dispatch  #
#########################
info () {
  case "$1" in 
    bwapp)
      info_proyecto_bwapp
      ;;
    webgoat7)
      info_proyecto_webgoat7
      ;;
    nodegoat)
      info_proyecto_nodegoat      
      ;;
    mutillidae)
      info_proyecto_mutillidae
    ;;
    vulnerablewordpress)
      info_proyecto_vulnerablewordpress
    ;;
    *) 
    echo "Nombre de projecto desconocido!!"
      list
    ;;
  esac  
}

#    Remuevo hosts    #
#######################
# Based on https://gist.github.com/irazasyed/a7b0a079e7727a4315b9
function removerhost() {
    if [ -n "$(grep $1 /etc/hosts)" ]
    then
        echo "Removiendo $1 desde $HOSTS";
        sudo sed -i".bak" "/$1/d" $HOSTS
    else
        echo "$1 no fue encontrado en $HOSTS";
    fi
}

function agregarhost() { # ex.   127.10.0.1	bwapp
    HOSTS_LINE="$1\t$2"
    if [ -n "$(grep $2 /etc/hosts)" ]
        then
            echo "$2 existe en /etc/hosts"
        else
            echo "Agregando $2 a tu $HOSTS";
            sudo -- sh -c -e "echo '$HOSTS_LINE' >> /etc/hosts";

            if [ -n "$(grep $2 /etc/hosts)" ]
                then
                    echo -e "$HOSTS_LINE fue agregado exitosamente a /etc/hosts";
                else
                    echo "Fallo para agregar $2, Intente nuevamente!!";
            fi
    fi
}


# INFORMACION DEL PROYECTO Y ARRANQUE #
#######################################
info_proyecto_bwapp () 
{
echo
echo " bWAPP es una aplicación PHP que utiliza una base de datos MySQL. Se puede alojar en Linux/Windows"
echo " con Apache/IIS y MySQL. También se puede instalar con WAMP o XAMPP".
echo " Otra posibilidad es descargar bee-box, una máquina virtual Linux personalizada preinstalada con bWAPP".
echo
echo " Descargue nuestro tutorial de introducción ¿Qué es bWAPP?, que incluye ejercicios gratuitos..."
echo
echo " bWAPP es solo para fines educativos y de prueba de seguridad de aplicaciones web".
echo " ¡Diviértete con este proyecto gratuito y de código abierto!"
echo
echo " Salud, Malik Mesellem"
echo " http://www.itsecgames.com/"
echo
echo " TECNOLOGÍA: PHP / MySQL"
echo " CARACTERÍSTICAS: DIFERENTES NIVELES DE HABILIDAD"
}

infoarranque_proyecto_bwapp () 
{
  echo "Recuerde ejecutar install.php antes de usar bwapp por primera vez."
  echo "at http://bwapp/install.php"
  echo "username/password por Defecto:  bee/bug"
  echo "bWAPP estara disponible en http://bwapp"
}

info_proyecto_webgoat7 () 
{
echo "WebGoat es una aplicación web deliberadamente insegura mantenida por OWASP diseñada para enseñar"
echo "Lecciones de seguridad de aplicaciones web. Puede instalar y practicar con WebGoat".
echo "su comprensión de un problema de seguridad mediante la explotación de una vulnerabilidad real en el"
echo "Aplicaciones WebGoat. Por ejemplo, en una de las lecciones el usuario debe usar inyección SQL"
echo "para robar números de tarjetas de crédito falsos. La aplicación tiene como objetivo proporcionar una enseñanza realista"
echo "entorno, que brinda a los usuarios sugerencias y código para explicar mejor la lección"
echo
echo "¿Por qué el nombre WebGoat? Los desarrolladores no deberían sentirse mal por no conocer la seguridad. Incluso los mejores programadores cometen errores de seguridad. Lo que necesitan es un chivo expiatorio, ¿verdad? ¡Cúlpale a la Cabra!"
echo
echo " https://www.owasp.org/index.php/Category:OWASP_WebGoat_Project"
echo
echo "TECNOLOGÍA: J2EE JAVA"
echo "CARACTERÍSTICAS: LECCIONES"
}

infoarranque_proyecto_webgoat7 () 
{
  echo "WebGoat 7.1 estara disponible en http://webgoat7/WebGoat"
}

info_proyecto_nodegoat () 
{
echo "NodeGoat es una aplicación web deliberadamente insegura mantenida por OWASP diseñada para enseñar"
echo "Lecciones de seguridad de aplicaciones web. Puede instalar y practicar con NodeGoat".
echo "Hay otras cabras como NodeGoat para Node.js. En cada lección, los usuarios deben demostrar"
echo "su comprensión de un problema de seguridad mediante la explotación de una vulnerabilidad real en el"
echo "Aplicaciones NodeGoat. Por ejemplo, en una de las lecciones el usuario debe usar inyecciones de javascript"
echo "para robar números de tarjetas de crédito falsos. La aplicación tiene como objetivo proporcionar una enseñanza realista"
echo "entorno, brindando a los usuarios sugerencias y código para explicar mejor la lección"
echo
echo "¿Por qué el nombre NodeGoat? Los desarrolladores no deberían sentirse mal por no conocer la seguridad. Incluso los mejores programadores cometen errores de seguridad. Lo que necesitan es un chivo expiatorio, ¿verdad? ¡Solo culpen a la Cabra!"
echo
echo "https://wiki.owasp.org/index.php/Projects/OWASP_Node_js_Goat_Project"
echo "Líder del proyecto Chetan Karande"
echo
echo "TECNOLOGÍA: Node.js NoSQL"
echo "CARACTERÍSTICAS: LECCIONES"
}

infoarranque_proyecto_nodegoat () 
{
  echo "NodeGoat 1.3 estara disponible en http://nodegoat.net/login"
  echo "Datos Login - usuario:demo password:demo"
  echo "También se pueden agregar nuevos usuarios mediante la página de registro."
}

info_proyecto_mutillidae () 
{
echo "NOWASP (Mutillidae) es una aplicación web gratuita, de código abierto y deliberadamente vulnerable"
echo "proporcionando un objetivo para los entusiastas de la seguridad web".
echo "Proyecto Incubadora OWASP. Líder Jeremy Druin"
echo
echo "TECNOLOGÍA: PHP / MySQL"
echo "CARACTERÍSTICAS: "

}

infoarranque_proyecto_mutillidae () 
{
  echo "OWASP Mutillidae II estara disponible en http://mutillidae"
  echo "Recuerde hacer clic en el enlace crear base de datos antes de comenzar"
}

info_proyecto_vulnerablewordpress () 
{
echo "https://github.com/wpscanteam/VulnerableWordpress"
echo "Aplicacion Wordpress Vulnerable"
echo "TECH: PHP / MySQL"
}

infoarranque_proyecto_vulnerablewordpress () 
{
  echo "WPScan El sitio vulnerable de Wordpress ahora está disponible en localhost en http://vulnerablewordpress"
}

# Arranque de Proyecto #
########################
arranque_proyecto ()
{
  fullname=$1			# ex. WebGoat 7.1
  projectname=$2     	# ex. webgoat7
  dockername=$3  		# ex. raesene/bwapp
  ip=$4   				# ex. 127.5.0.1
  port=$5				# ex. 80
  port2=$6				# optional second port binding
  
  echo "Arrancando $fullname"
  agregarhost "$ip" "$projectname"


  if [ "$(sudo docker ps -aq -f name=$projectname)" ]; 
  then
    echo "Corriendo comando: Abrir Docker " +  $projectname
    sudo docker start $projectname
  else
    if [ -n "${6+set}" ]; then
      echo "Corriendo commando: docker run --name $projectname -d -p $ip:80:$port -p $ip:$port2:$port2 $dockername"
      sudo docker run --name $projectname -d -p $ip:80:$port -p $ip:$port2:$port2 $dockername
    else echo "not set";
      echo "Corriendo commando: docker run --name $projectname -d -p $ip:80:$port $dockername"
      sudo docker run --name $projectname -d -p $ip:80:$port $dockername
    fi
  fi
  echo "HECHO!"
  echo
  echo "Docker mapeado a http://$projectname o http://$ip"
  echo
}

# Detener Proyecto   #
######################
detener_proyecto ()
{
  fullname=$1			# ex. WebGoat 7.1
  projectname=$2    	# ex. webgoat7

  echo "Deteniendo... " + $fullname
  echo "Comando corriendo: detener docker " + $projectname
  sudo docker stop $projectname
  removerhost "$projectname"
}


estado_proyecto()
{
  if [ "$(sudo docker ps -q -f name=bwapp)" ]; then
    echo "bWaPP				corriendo en http://bwapp"
  else 
    echo "bWaPP				no ejecutado"
  fi
  if [ "$(sudo docker ps -q -f name=webgoat7)" ]; then
    echo "WebGoat 7.1			corriendo en http://webgoat7/WebGoat"
  else 
    echo "WebGoat 7.1			no ejecutado"  
  fi
  if [ "$(sudo docker ps -q -f name=nodegoat)" ]; then
    echo "NodeGoat 1.3			corriendo en http://nodegoat.net/login"
  else 
    echo "NodeGoat 1.3			no ejecutado"  
  fi
  if [ "$(sudo docker ps -q -f name=mutillidae)" ]; then
    echo "Mutillidae II			corriendo en http://mutillidae"
  else 
    echo "Mutillidae II			no ejecutado"  
  fi
  if [ "$(sudo docker ps -q -f name=vulnerablewordpress)" ]; then
    echo "WPScan Vulnerable Wordpress 	corriendo en http://vulnerablewordpress"
  else 
    echo "WPScan Vulnerable Wordpress	no ejecutado"  
  fi
}

arranque_proyecto_dispatch()
{
  case "$1" in
    bwapp)
      arranque_proyecto "bWAPP" "bwapp" "raesene/bwapp" "127.10.0.1" "80"
      infoarranque_proyecto_bwapp
    ;;
    webgoat7)
      arranque_proyecto "WebGoat 7.1" "webgoat7" "webgoat/webgoat-7.1" "127.20.0.1" "8080"
      infoarranque_proyecto_webgoat7
    ;;
    nodegoat)
      arranque_proyecto "NodeGoat 1.3" "nodegoat" "bjm243/nodegoat" "127.30.0.1" "4000"
      infoarranque_proyecto_nodegoat
    ;;
    mutillidae)
      arranque_proyecto "Mutillidae II" "mutillidae" "citizenstig/nowasp" "127.40.0.1" "80"
      infoarranque_proyecto_mutillidae
    ;;
    vulnerablewordpress)
      arranque_proyecto "WPScan Vulnerable Wordpress" "vulnerablewordpress" "l505/vulnerablewordpress" "127.50.0.1" "80" "3306"
      infoarranque_proyecto_vulnerablewordpress
    ;;
    *)
    echo "ERROR: No se reconoce el nombre del proyecto !!" 
    ;;
  esac  
}

parar_proyecto_dispatch()
{
  case "$1" in
    bwapp)
      detener_proyecto "bWAPP" "bwapp"
    ;;
    webgoat7)
      detener_proyecto "WebGoat 7.1" "webgoat7"
    ;;
    nodegoat)
      detener_proyecto "NodeGoat 1.3" "nodegoat"
    ;;
    mutillidae)
      detener_proyecto "Mutillidae II" "mutillidae"
    ;;
     vulnerablewordpress)
      detener_proyecto "WPScan Vulnerable Wordpress" "vulnerablewordpress"
    ;;
    *)
    echo "ERROR: Project dispatch doesn't recognize the project name" 
    ;;
  esac  
}

# Menu Seleccion Principal #
#############################
case "$1" in
  start)
    if [ -z "$2" ]
    then
      echo "ERROR: Se necesita nombre de proyecto para esta opcion, en minusculas !!"
      echo 
      list # call list ()
      break
    fi
    arranque_proyecto_dispatch $2
    ;;
  stop)
    if [ -z "$2" ]
    then
      echo "ERROR: Se necesita nombre de proyecto para esta opcion, en minusculas !!"
      echo 
      list # call list ()
      break
    fi
    parar_proyecto_dispatch $2
    ;;
  list)
    list # call list ()
    ;;
  status)
    estado_proyecto # call estado_proyecto ()
    ;;
  info)
    if [ -z "$2" ]
    then
      echo "ERROR: Se necesita nombre de proyecto para esta opcion, en minusculas !!"
      echo 
      list # call list ()
      break
    fi
    info $2
    ;;
  *)
    despliega_help
;;
esac  
